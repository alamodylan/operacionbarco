{# templates/placas.html #}
{% extends "base.html" %}

{% block title %}Gesti√≥n de Placas{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">üöõ Placas registradas</h2>

    {% if placas %}
      <!-- ‚úÖ √öNICO BOT√ìN EDITAR -->
      <button id="btnEditar" type="button" class="btn btn-outline-primary">
        ‚úèÔ∏è Editar
      </button>
    {% endif %}
  </div>

  <!-- Formulario para agregar nueva placa -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form
        method="POST"
        action="{{ url_for('placa_bp.nueva_placa') }}"
        class="row g-2"
      >
        <div class="col-md-4">
          <input
            type="text"
            name="numero_placa"
            class="form-control"
            placeholder="Placa"
            required
          >
        </div>

        <div class="col-md-4">
          <input
            type="text"
            name="propietario"
            class="form-control"
            placeholder="Chofer"
          >
        </div>

        <div class="col-md-3">
          <input
            type="text"
            name="color_cabezal"
            class="form-control"
            placeholder="Color cabezal (ej: Rojo)"
          >
        </div>

        {# ‚úÖ Opcional: si quer√©s poder cargar identificador fijo al crear #}
        {# 
        <div class="col-md-3">
          <input
            type="text"
            name="identificador_fijo"
            class="form-control"
            placeholder="Identificador fijo (ej: 1001)"
          >
        </div>
        #}

        <div class="col-md-1 d-grid">
          <button type="submit" class="btn btn-primary">Agregar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- üîé BUSCADOR -->
  <div class="input-group mb-3">
    <span class="input-group-text">üîç Buscar</span>
    <input
      type="text"
      id="buscadorPlacas"
      class="form-control"
      placeholder="Buscar por placa, chofer, color, identificador, estado, usuario‚Ä¶"
    >
  </div>

  {% if placas %}
    <!-- ‚úÖ UN SOLO FORM PARA TODA LA TABLA -->
    <form
      method="POST"
      action="{{ url_for('placa_bp.actualizar_placas_batch') }}"
      id="formBatch"
    >
      <div class="table-responsive">
        <table class="table table-hover align-middle shadow-sm" id="tablaPlacas">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>N√∫mero de placa</th>
              <th>Chofer</th>
              <th>Color cabezal</th>
              <th>Identificador fijo</th>
              <th>Registrado por</th>
              <th>Fecha de registro</th>
              <th>Estado</th>
            </tr>
          </thead>

          <tbody>
            {% for placa in placas %}
              <tr class="fila-placa">
                <td>{{ placa.id }}</td>
                <td class="fw-bold">{{ placa.numero_placa }}</td>

                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm editable"
                    name="propietario[{{ placa.id }}]"
                    value="{{ placa.propietario or '' }}"
                    placeholder="Chofer"
                    disabled
                  >
                </td>

                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm editable"
                    name="color_cabezal[{{ placa.id }}]"
                    value="{{ placa.color_cabezal or '' }}"
                    placeholder="Ej: Rojo"
                    disabled
                  >
                </td>

                <!-- ‚úÖ NUEVO: Identificador fijo -->
                <td>
                  <input
                    type="text"
                    class="form-control form-control-sm editable"
                    name="identificador_fijo[{{ placa.id }}]"
                    value="{{ placa.identificador_fijo or '' }}"
                    placeholder="Ej: 1001"
                    disabled
                  >
                </td>

                <td>{{ placa.usuario.nombre if placa.usuario else '‚Äî' }}</td>

                <td>{{ placa.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>

                <!-- ‚úÖ Estado tambi√©n en batch (SIN form aparte) -->
                <td>
                  <select
                    name="estado[{{ placa.id }}]"
                    class="form-select form-select-sm editable"
                    disabled
                  >
                    <option value="Activa" {% if placa.estado == 'Activa' %}selected{% endif %}>
                      Activa
                    </option>
                    <option value="Inactiva" {% if placa.estado == 'Inactiva' %}selected{% endif %}>
                      Inactiva
                    </option>
                  </select>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ‚úÖ UN SOLO BOT√ìN GUARDAR AL FINAL (aparece al editar) -->
      <div class="d-flex justify-content-end mt-3">
        <button id="btnGuardar" type="submit" class="btn btn-success d-none">
          üíæ Guardar cambios
        </button>
      </div>
    </form>
  {% else %}
    <div class="alert alert-info text-center mt-4">
      No hay placas registradas a√∫n.
    </div>
  {% endif %}
</div>

<script>
  // Buscador en vivo
  const buscador = document.getElementById("buscadorPlacas");
  if (buscador) {
    buscador.addEventListener("keyup", function () {
      const filtro = this.value.toLowerCase();
      const filas = document.querySelectorAll("#tablaPlacas tbody tr.fila-placa");

      filas.forEach((fila) => {
        fila.style.display = fila.innerText.toLowerCase().includes(filtro) ? "" : "none";
      });
    });
  }

  // Editar / Guardar
  const btnEditar = document.getElementById("btnEditar");
  const btnGuardar = document.getElementById("btnGuardar");
  const editables = document.querySelectorAll(".editable");

  if (btnEditar) {
    btnEditar.addEventListener("click", () => {
      editables.forEach((el) => (el.disabled = false));
      btnGuardar.classList.remove("d-none");
      btnEditar.disabled = true;
    });
  }
</script>
{% endblock %}