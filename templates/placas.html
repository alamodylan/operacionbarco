{% extends "base.html" %}
{% block title %}Gesti√≥n de Placas{% endblock %}
{% block content %}

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">üöõ Placas registradas</h2>
  </div>

  <!-- Formulario para agregar nueva placa -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form method="POST" action="{{ url_for('placa_bp.nueva_placa') }}" class="row g-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-md-4">
          <input type="text" name="numero_placa" class="form-control" placeholder="Placa" required>
        </div>

        <div class="col-md-4">
          <input type="text" name="propietario" class="form-control" placeholder="Chofer">
        </div>

        <div class="col-md-3">
          <input type="text" name="color_cabezal" class="form-control" placeholder="Color cabezal (ej: Rojo)">
        </div>

        <div class="col-md-1 d-grid">
          <button type="submit" class="btn btn-primary">Agregar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- üîé BUSCADOR -->
  <div class="input-group mb-3">
    <span class="input-group-text">üîç Buscar</span>
    <input
      type="text"
      id="buscadorPlacas"
      class="form-control"
      placeholder="Buscar por placa, chofer, color, estado, usuario‚Ä¶">
  </div>

  {% if placas %}
  <div class="table-responsive">
    <table class="table table-hover align-middle shadow-sm" id="tablaPlacas">
      <thead class="table-primary">
        <tr>
          <th>ID</th>
          <th>N√∫mero de placa</th>
          <th>Chofer</th>
          <th>Color cabezal</th>
          <th>Registrado por</th>
          <th>Fecha de registro</th>
          <th>Estado</th>
          <th class="text-end">Guardar</th>
        </tr>
      </thead>

      <tbody>
        {% for placa in placas %}
        <tr class="fila-placa">

          <td>{{ placa.id }}</td>

          <td class="fw-bold">{{ placa.numero_placa }}</td>

          <!-- ‚úÖ FORM 1: Actualizar chofer + color (inline) -->
          <td>
            <form method="POST" action="{{ url_for('placa_bp.actualizar_placa', placa_id=placa.id) }}" class="d-flex gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="text"
                     name="propietario"
                     class="form-control form-control-sm"
                     value="{{ placa.propietario or '' }}"
                     placeholder="Chofer">
          </td>

          <td>
              <input type="text"
                     name="color_cabezal"
                     class="form-control form-control-sm"
                     value="{{ placa.color_cabezal or '' }}"
                     placeholder="Ej: Rojo">
          </td>

          <td>{{ placa.usuario.nombre if placa.usuario else '‚Äî' }}</td>

          <td>{{ placa.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>

          <!-- ‚úÖ FORM 2: Cambiar estado -->
          <td>
            <form method="POST" action="{{ url_for('placa_bp.cambiar_estado', placa_id=placa.id) }}" class="d-flex align-items-center">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <select name="estado" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="Activa" {% if placa.estado == 'Activa' %}selected{% endif %}>Activa</option>
                <option value="Inactiva" {% if placa.estado == 'Inactiva' %}selected{% endif %}>Inactiva</option>
              </select>
            </form>
          </td>

          <!-- Bot√≥n guardar del FORM 1 -->
          <td class="text-end">
              <button type="submit" class="btn btn-sm btn-success">
                üíæ Guardar
              </button>
            </form>
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info text-center mt-4">
    No hay placas registradas a√∫n.
  </div>
  {% endif %}
</div>

<!-- üîé Buscador en vivo (solo filas principales) -->
<script>
document.getElementById("buscadorPlacas").addEventListener("keyup", function() {
  const filtro = this.value.toLowerCase();
  const filas = document.querySelectorAll("#tablaPlacas tbody tr.fila-placa");

  filas.forEach(fila => {
    const texto = fila.innerText.toLowerCase();
    fila.style.display = texto.includes(filtro) ? "" : "none";
  });
});
</script>

{% endblock %}