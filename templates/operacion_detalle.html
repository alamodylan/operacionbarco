{% extends "base.html" %}
{% block title %}Detalle Operaci√≥n{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">
            ‚öì Detalle de Operaci√≥n: {{ operacion.nombre }}
            <small class="text-muted">({{ operacion.tipo_operacion|capitalize }})</small>
        </h2>

        {% if rol == 'Admin' %}
        <form action="{{ url_for('operacion_bp.finalizar_operacion', operacion_id=operacion.id) }}" method="POST">
            <button type="submit" class="btn btn-success">
                Finalizar operaci√≥n
            </button>
        </form>
        {% endif %}
    </div>

    <p class="text-muted">
        Creada el {{ operacion.fecha_creacion.strftime('%d/%m/%Y %H:%M') }} |
        Estado:
        {% if operacion.estado == 'en_proceso' %}
            <span class="badge bg-warning text-dark">En proceso</span>
        {% elif operacion.estado == 'finalizada' %}
            <span class="badge bg-success">Finalizada</span>
        {% else %}
            <span class="badge bg-secondary">{{ operacion.estado }}</span>
        {% endif %}
    </p>

    <hr>

    {% if operacion.estado == 'en_proceso' %}

        {% set permite_salida =
            (rol == 'Admin') or
            (rol == 'UsuarioPredio' and operacion.tipo_operacion == 'exportacion') or
            (rol == 'UsuarioMuelle' and operacion.tipo_operacion == 'importacion')
        %}

        {% if permite_salida %}
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3 fw-bold">üöõ Agregar movimiento (Salida)</h5>

                <form method="POST"
                      action="{{ url_for('operacion_bp.agregar_movimiento', operacion_id=operacion.id) }}"
                      class="row g-2"
                      id="formNuevoMovimiento">

                    <div class="col-md-4">
                        <label class="form-label mb-1">Identificador</label>
                        <div class="input-group">
                            <input type="text"
                                   id="identificador"
                                   class="form-control"
                                   placeholder="Seleccionar identificador..."
                                   readonly
                                   required>
                            <button type="button" class="btn btn-outline-primary" onclick="openIdentModal()">
                                Buscar
                            </button>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label mb-1">Placa (autom√°tica)</label>
                        <input type="text"
                               id="placa_text"
                               class="form-control"
                               placeholder="Se llena al elegir identificador"
                               readonly>
                        <input type="hidden" id="placa_id" name="placa_id" required>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label mb-1">N¬∞ Identificador</label>
                        <input type="text"
                               name="contenedor"
                               id="contenedor"
                               class="form-control"
                               readonly
                               required>
                    </div>

                    <div class="col-md-2 d-grid">
                        <label class="form-label mb-1">&nbsp;</label>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>

                </form>
            </div>
        </div>

        <!-- Modal buscador -->
        <div class="modal fade" id="identModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Buscar Identificador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>

              <div class="modal-body">
                <input id="ident_q" class="form-control" placeholder="Escrib√≠ el identificador...">
                <div class="mt-3 list-group" id="ident_results"></div>
                <div class="form-text mt-2">
                  Solo aparecen identificadores ligados a una placa activa.
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
        let identTimer = null;

        function openIdentModal(){
          const modal = new bootstrap.Modal(document.getElementById("identModal"));
          modal.show();
          setTimeout(() => document.getElementById("ident_q").focus(), 150);
        }

        document.addEventListener("input", (e) => {
          if (e.target && e.target.id === "ident_q") {
            clearTimeout(identTimer);
            identTimer = setTimeout(() => buscarIdentificador(e.target.value), 200);
          }
        });

        async function buscarIdentificador(q){
          q = (q || "").trim();
          const box = document.getElementById("ident_results");
          box.innerHTML = "";

          if(!q){
            box.innerHTML = `<div class="text-muted">Escrib√≠ para buscar‚Ä¶</div>`;
            return;
          }

          // ‚úÖ con url_prefix="/placas"
          const resp = await fetch(`/placas/buscar-identificador?q=${encodeURIComponent(q)}`);
          const data = await resp.json();

          if(!data.length){
            box.innerHTML = `<div class="text-muted">Sin resultados</div>`;
            return;
          }

          box.innerHTML = data.map(r => `
            <button type="button" class="list-group-item list-group-item-action"
              onclick="selectIdent('${escapeHtml(r.identificador)}', ${r.id}, '${escapeHtml(r.placa)}')">
              <div class="d-flex justify-content-between">
                <div><strong>${escapeHtml(r.identificador)}</strong> ‚Äî ${escapeHtml(r.placa)}</div>
                <small class="text-muted">${escapeHtml(r.propietario || '')}</small>
              </div>
            </button>
          `).join("");
        }

        function selectIdent(ident, placaId, placa){
          document.getElementById("identificador").value = ident;
          document.getElementById("placa_text").value = placa;

          document.getElementById("placa_id").value = placaId;

          // Guardamos identificador en el campo existente (mov.contenedor)
          document.getElementById("contenedor").value = ident;

          bootstrap.Modal.getInstance(document.getElementById("identModal")).hide();
        }

        function escapeHtml(s){
          return (s || "").replace(/[&<>"']/g, m => ({
            '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
          }[m]));
        }

        document.getElementById("formNuevoMovimiento")?.addEventListener("submit", (e) => {
          const pid = document.getElementById("placa_id").value;
          const cont = document.getElementById("contenedor").value;
          if(!pid || !cont){
            e.preventDefault();
            alert("Seleccion√° un identificador para cargar la placa autom√°ticamente.");
          }
        });
        </script>

        {% endif %}
    {% endif %}

    <!-- Tabla de movimientos -->
    <div class="table-responsive shadow-sm">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Placa</th>
                    <th>N¬∞ Identificador</th>
                    <th>Hora salida</th>
                    <th>Hora llegada</th>
                    <th>Duraci√≥n</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>

            <tbody>
                {% if movimientos %}
                    {% for mov in movimientos %}

                    {% set permite_finalizar =
                        (rol == 'Admin') or
                        (rol == 'UsuarioPredio' and operacion.tipo_operacion == 'importacion') or
                        (rol == 'UsuarioMuelle' and operacion.tipo_operacion == 'exportacion')
                    %}

                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ mov.placa.numero_placa }}</td>
                        <td>{{ mov.contenedor }}</td>
                        <td>{{ mov.hora_salida.strftime('%d/%m/%Y %H:%M') }}</td>

                        <td>
                            {% if mov.hora_llegada %}
                                {{ mov.hora_llegada.strftime('%d/%m/%Y %H:%M') }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>

                        <td>
                            {% if mov.hora_llegada %}
                                {{ mov.tiempo_total(formato=True) }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>

                        <td>
                            {% if mov.estado == 'en_ruta' %}
                                <span class="badge bg-warning text-dark">En ruta</span>
                            {% elif mov.estado == 'finalizado' %}
                                <span class="badge bg-success">Finalizado</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ mov.estado }}</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if mov.estado == 'en_ruta' and permite_finalizar %}
                            <form method="POST" action="{{ url_for('operacion_bp.finalizar_movimiento', movimiento_id=mov.id) }}">
                                <button type="submit" class="btn btn-sm btn-success">Finalizar</button>
                            </form>
                            {% else %}
                                <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>

                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No hay movimientos registrados en esta operaci√≥n.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <a href="{{ url_for('operacion_bp.listar_operaciones') }}" class="btn btn-outline-secondary mt-3">
        ‚Üê Volver a Operaciones
    </a>

</div>
{% endblock %}